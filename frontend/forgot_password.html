<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Récupération Compte | Palestine Future</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('t')) {
                window.location.replace('ask_ben.html?t=' + Math.random().toString(36).substring(7));
            }
        })();
    </script>

    <style>
        :root { --bg-dark: #050505; --green: #009736; --white: #fff; }
        body {
            background-color: var(--bg-dark);
            color: var(--white);
            font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0;
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
        }
        .box {
            background: rgba(20, 20, 20, 0.95);
            padding: 40px;
            border-radius: 15px; border: 1px solid #333;
            width: 400px; text-align: center;
            box-shadow: 0 0 30px rgba(0, 151, 54, 0.1);
        }
        h2 { color: var(--green); margin-bottom: 20px; }
        input {
            width: 100%; padding: 12px;
            background: #000; border: 1px solid #333;
            color: white; border-radius: 5px; margin-bottom: 15px;
            outline: none;
        }
        input:focus { border-color: var(--green); }
        button {
            width: 100%; padding: 12px;
            background: var(--green); color: white; border: none;
            cursor: pointer; border-radius: 5px; font-weight: bold;
        }
        button:hover { background: #007a2b; }
        .step { display: none; }
        .step.active { display: block; animation: fade 0.5s; }
        @keyframes fade { from {opacity:0;} to{opacity:1;} }

        .strength-meter { 
            height: 4px; background: #333; margin-top: 5px; margin-bottom: 15px; 
            border-radius: 2px; overflow: hidden; display: none;
        }
        .strength-bar { height: 100%; width: 0; transition: width 0.3s, background 0.3s; }
    </style>
</head>
<body>
    <div class="box">
        <i class="fas fa-key" style="font-size: 2rem; color: var(--green); margin-bottom: 20px;"></i>
        <h2>Récupération</h2>

        <div id="step1" class="step active">
            <p style="color:#aaa; margin-bottom:20px; font-size:0.9rem;">Entrez votre email pour récupérer votre question secrète.</p>
            <input type="email" id="resetEmail" placeholder="votre@email.com">
            <button onclick="fetchQuestion()">Rechercher</button>
        </div>

        <div id="step2" class="step">
            <p style="color:var(--green); margin-bottom:10px; font-weight:bold;">Question de sécurité :</p>
            <p id="qText" style="margin-bottom:20px; font-style:italic;">?</p>
            
            <input type="text" id="resetAnswer" placeholder="Votre réponse...">
            
            <input type="password" id="newPassword" placeholder="Nouveau mot de passe">
            <div class="strength-meter" id="meterBox">
                <div class="strength-bar" id="strengthBar"></div>
            </div>

            <button onclick="submitReset()">Réinitialiser</button>
        </div>

        <div id="step3" class="step">
            <i class="fas fa-check-circle" style="font-size:3rem; color:var(--green); margin-bottom:20px;"></i>
            <p>Mot de passe modifié avec succès.</p>
            <button onclick="window.location.href='ask_ben.html'" style="margin-top:20px;">Se connecter</button>
        </div>

        <p id="msg" style="color:#ce1126; margin-top:15px; font-size:0.9rem;"></p>
        <a href="ask_ben.html" style="display:block; margin-top:20px; color:#666; font-size:0.8rem; text-decoration:none;">Annuler</a>
    </div>

    <script>
        let userEmail = '';

        async function fetchQuestion() {
            const email = document.getElementById('resetEmail').value;
            const btn = document.querySelector('#step1 button');
            const msg = document.getElementById('msg');
            msg.innerText = '';

            if(!email) { msg.innerText = "Email requis."; return; }

            btn.disabled = true; btn.innerText = "...";

            try {
                const res = await fetch('/api/auth/get-security-question', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if(data.success) {
                    userEmail = email;
                    document.getElementById('qText').innerText = data.question;
                    switchStep(2);
                } else {
                    msg.innerText = data.msg;
                }
            } catch(e) { msg.innerText = "Erreur serveur."; }
            btn.disabled = false; btn.innerText = "Rechercher";
        }

        async function submitReset() {
            const answer = document.getElementById('resetAnswer').value;
            const newPassword = document.getElementById('newPassword').value;
            const msg = document.getElementById('msg');
            const btn = document.querySelector('#step2 button');
            msg.innerText = '';

            if(!answer || !newPassword) { msg.innerText = "Tous les champs sont requis."; return; }

            btn.disabled = true; btn.innerText = "...";

            try {
                const res = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: userEmail, answer, newPassword })
                });
                const data = await res.json();

                if(data.success) {
                    switchStep(3);
                } else {
                    msg.innerText = data.msg;
                }
            } catch(e) { msg.innerText = "Erreur serveur."; }
            btn.disabled = false; btn.innerText = "Réinitialiser";
        }


        document.getElementById('newPassword').addEventListener('input', function(e) {
            const pwd = e.target.value;
            const meterBox = document.getElementById('meterBox');
            const bar = document.getElementById('strengthBar');
            
            if(pwd.length === 0) {
                meterBox.style.display = 'none';
                return;
            }
            meterBox.style.display = 'block';

            let strength = 0;
            if(pwd.length > 5) strength += 20;
            if(pwd.length > 10) strength += 20;
            if(/[A-Z]/.test(pwd)) strength += 20;
            if(/[0-9]/.test(pwd)) strength += 20;
            if(/[^A-Za-z0-9]/.test(pwd)) strength += 20;

            bar.style.width = strength + '%';
            
            if(strength < 40) bar.style.background = '#ff4444'; 
            else if(strength < 80) bar.style.background = '#ffbb33'; 
            else bar.style.background = '#00C851'; 
        });
        function switchStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step'+n).classList.add('active');
            document.getElementById('msg').innerText = '';
        }
    </script>
    <script src="cursor.js"></script>
</body>
</html>